#!/usr/bin/env ruby
# frozen_string_literal: true

Encoding.default_internal = Encoding::UTF_8
Encoding.default_external = Encoding::UTF_8
# compute gem source root based on this script location
GEM_ROOT = File.dirname(File.dirname(File.realpath(__FILE__)))
# coverage for tests
if ENV.key?('ENABLE_COVERAGE')
  require 'simplecov'
  require 'securerandom'
  SimpleCov.root(GEM_ROOT)
  SimpleCov.enable_for_subprocesses if SimpleCov.respond_to?(:enable_for_subprocesses)
  # keep cache data for 1 day (must be longer that time to run the whole test suite)
  SimpleCov.merge_timeout(86400)
  SimpleCov.command_name(SecureRandom.uuid)
  SimpleCov.at_exit do
    original_file_descriptor = $stdout
    $stdout.reopen(File.join(GEM_ROOT, 'simplecov.log'))
    SimpleCov.result.format!
    $stdout.reopen(original_file_descriptor)
  end
  SimpleCov.start
end
# if in development, add path to gem
$LOAD_PATH.unshift(File.join(GEM_ROOT, 'lib'))
require 'aspera/cli/main'
require 'aspera/environment'
Aspera::Environment.fix_home
Aspera::Cli::Main.new(ARGV).process_command_line
