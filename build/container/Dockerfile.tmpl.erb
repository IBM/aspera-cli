# Embedded Ruby template
# Lines beginning with "#erb:" are embedded ruby lines.
# Processing is done in Makefile to avoid syntax error in Dockerfile
# @param arg_gem specify a gemfile or a gem version
# @param arg_opt specify list of optional gems
# Review the version of Ruby to be used periodically from :
# https://hub.docker.com/_/ruby
# "-slim" image not used because rmagick requires native compilation
FROM docker.io/ruby:3.4.8
#erb: if arg_gem.end_with?('.gem')
# For beta, gem is file, then copy it.
COPY <%=arg_gem%> .
# If a gem file was provided, once copied in container: use the basename only
#erb: arg_gem=File.basename(arg_gem)
#erb: end
# Install aspera-cli gem (beta or release), optional gems and other packages
# Install SDK, create key files and check that ascp works
RUN \
  apt-get update && \
  apt-get install -y imagemagick optipng && \
  apt-get clean && \
  rm -fr /var/lib/apt/lists/* && \
  gem install <%=arg_opt%> <%=arg_gem%> && \
  rm -f <%=arg_gem%> && \
  useradd -m -u 1000 -s /bin/bash cliuser
# rootless execution
USER cliuser
RUN \
  ascli conf ascp install && \
  ascli conf ascp info
# Default cwd when starting the container
WORKDIR /home/cliuser
ENTRYPOINT ["ascli"]
CMD ["help"]
